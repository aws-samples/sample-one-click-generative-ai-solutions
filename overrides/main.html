{% extends "base.html" %}

{% block libs %}
{{ super() }}
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2FHDMP8T1L"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-2FHDMP8T1L');
</script>

<!-- Region selector script -->
<script>
  document.addEventListener('DOMContentLoaded', function() {    
    // Function to generate timestamp suffix for stack names
    function generateTimestampSuffix() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      // Format: -yyyyMMddTHHmmss (using hyphen before timestamp and T as separator)
      return `-${year}${month}${day}T${hours}${minutes}${seconds}`;
    }

    // Function to update deployment URL based on selected region
    function updateDeploymentUrl(deploymentContainer, region) {
      const deploymentLinks = deploymentContainer.querySelectorAll('.deployment-button');
      deploymentLinks.forEach(function(link) {
        const currentHref = link.getAttribute('href');
        // Replace region in URL
        const newHref = currentHref.replace(/https:\/\/[^.]+\.console\.aws\.amazon\.com/, 
          `https://${region}.console.aws.amazon.com`);
        link.setAttribute('href', newHref);
      });
    }

    // Initialize region selectors
    const deploymentContainers = document.querySelectorAll('.solution-card__actions');
    deploymentContainers.forEach(function(container) {

      const selector = container.querySelector('.region-selector');
      if (selector) {
        // Set initial region based on current URL
        const deploymentLink = container.querySelector('.deployment-button');
        if (deploymentLink) {
          const currentHref = deploymentLink.getAttribute('href');
          const regionMatch = currentHref.match(/https:\/\/([^.]+)\.console\.aws\.amazon\.com/);
          if (regionMatch) {
            selector.value = regionMatch[1];
          }
        }

        // Add change event listener
        selector.addEventListener('change', function() {
          updateDeploymentUrl(container, this.value);
        });
      }

      const buttons = container.querySelectorAll('.deployment-button');
      if (buttons.length > 0) {
        buttons.forEach(function(button) {
          button.addEventListener('click', function(event) {
            event.preventDefault(); // Prevent default navigation
              
            const currentHref = this.getAttribute('href');
            const timestamp = generateTimestampSuffix();

            // Check if URL contains stackName parameter
            if (currentHref.includes('stackName=')) {
              // Replace stackName value with timestamp appended
              const updatedHref = currentHref.replace(
                /stackName=([^&]+)/,
                function(match, stackName) {
                  return `stackName=${stackName}${timestamp}`;
                }
              );
                        
              // Open the updated URL in a new tab
              window.open(updatedHref, '_blank');
            } else {
              // If no stackName parameter, just open as is
              console.log('No stackName parameter found, opening as is');
              window.open(currentHref, '_blank');
            }
          });
        });
      }
    });
  });
  </script>
{% endblock %}
